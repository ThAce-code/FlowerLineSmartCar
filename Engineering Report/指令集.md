# STM32F407VET6智能小车指令集参考手册

**版本**: 3.0 (完整版)
**日期**: 2025年7月
**作者**: Augment和刘宇航

## 概述

本文档提供STM32F407VET6智能小车串口指令系统的完整参考手册。新版本将原有的23个指令精简为12个参数化指令，在保持功能完整性的同时大幅提升了操作效率和用户体验。

### 系统特性

- **指令精简**: 23个指令 → 12个指令 (减少48%)
- **参数化设计**: 支持灵活的参数组合
- **功能整合**: 相关功能统一入口
- **操作效率**: 直接参数设置，无需交互式输入
- **中文友好**: 完整的中文错误提示和帮助信息

## 指令分类

### 电机控制指令 (3个)
- `pwm` - PWM控制和查看
- `start` - 启动电机
- `stop` - 停止电机

### 传感器数据指令 (2个)
- `sensor` - 显示所有传感器数据
- `encoder` - 编码器功能

### Gary灰度传感器指令 (3个)
- `gary` - 显示完整传感器信息
- `gary ping` - 检测传感器连接
- `gary reinit` - 重新初始化传感器

### 系统管理指令 (4个)
- `system` - 系统功能
- `page` - 页面切换
- `help` - 显示帮助信息

---

## 详细指令说明

### 1. PWM控制指令

#### 语法格式
```
pwm [left|right] [value]
```

#### 参数说明
- **无参数**: 显示当前左右轮PWM状态
- **left/right**: 指定要操作的轮子
- **value**: PWM值，范围 -1000 到 +1000
  - 正值: 正转
  - 负值: 反转
  - 0: 停止

#### 使用示例
```bash
pwm                    # 查看当前PWM状态
pwm left 500          # 设置左轮PWM为500
pwm right -300        # 设置右轮PWM为-300
pwm left 0            # 停止左轮
```

#### 响应示例
```
> pwm
左轮PWM:500
右轮PWM:-300

> pwm left 800
左轮PWM已设置为: 800
```

#### 错误处理
```
> pwm left 1500
错误：PWM值范围为 -1000 到 +1000

> pwm middle 500
错误：参数必须是 left 或 right
```

### 2. 电机启停指令

#### start - 启动电机
```bash
start                  # 启动电机系统
```
**响应**: "Motor started successfully"

#### stop - 停止电机
```bash
stop                   # 停止电机并清零速度数据
```
**响应**: "Motor stopped successfully"

### 3. 传感器数据指令

#### sensor - 显示所有传感器数据
```bash
sensor                 # 显示编码器+ADC+IMU数据
```

**响应内容**:
- 编码器A/B的RPS、RPM、m/s数据
- ADC电压值和原始值
- IMU的Roll、Pitch、Yaw角度
- 通信状态和更新时间

#### encoder - 编码器功能
```bash
encoder debug          # 显示编码器调试信息
encoder cal            # 执行编码器校准
```

**功能说明**:
- `debug`: 合并显示速度和计数器调试信息
- `cal`: 执行交互式编码器校准程序

### 4. Gary灰度传感器指令

#### gary - 显示完整传感器信息
```bash
gary                   # 显示完整Gary传感器信息
```

**响应内容**:
- 8通道数字/模拟/归一化数据
- 循线状态和位置偏差
- 系统状态和通信错误

#### gary ping - 检测传感器连接
```bash
gary ping              # 检测Gary传感器连接状态
```

#### gary reinit - 重新初始化传感器
```bash
gary reinit            # 重新初始化Gary传感器
```

### 5. 系统管理指令

#### system - 系统功能
```bash
system perf            # 显示性能统计
system reset           # 重置统计数据
system diag            # 系统诊断
```

#### page - 页面切换
```bash
page motor             # 切换到电机页面
page imu               # 切换到IMU页面
```

#### help - 显示帮助信息
```bash
help                   # 显示完整的指令帮助
```

---

## 新旧指令对照表

### 电机控制类

| 旧指令 | 新指令 | 说明 |
|--------|--------|------|
| `pls` | `pwm left <value>` | 设置左轮PWM |
| `prs` | `pwm right <value>` | 设置右轮PWM |
| `pc` | `pwm` | 查看PWM状态 |
| `start` | `start` | 启动电机 (保持不变) |
| `stop` | `stop` | 停止电机 (保持不变) |
| `mtest` | *已删除* | 电机测试功能已移除 |

### 传感器数据类

| 旧指令 | 新指令 | 说明 |
|--------|--------|------|
| `sc` | `sensor` | 编码器速度 → 所有传感器数据 |
| `ac` | `sensor` | ADC数据 → 所有传感器数据 |
| `imu show` | `sensor` | IMU数据 → 所有传感器数据 |
| `scd` | `encoder debug` | 速度调试 → 编码器调试 |
| `ecd` | `encoder debug` | 计数器调试 → 编码器调试 |
| `cal` | `encoder cal` | 编码器校准 |

### Gary传感器类

| 旧指令 | 新指令 | 说明 |
|--------|--------|------|
| `gary data` | `gary` | 传感器数据 → 完整信息 |
| `gary line` | `gary` | 循线状态 → 完整信息 |
| `gary state` | `gary` | 详细状态 → 完整信息 |
| `gary ping` | `gary ping` | 连接检测 (保持不变) |
| `gary reinit` | `gary reinit` | 重新初始化 (保持不变) |
| `gary debug` | *已删除* | 与gary data重复 |

### 系统管理类

| 旧指令 | 新指令 | 说明 |
|--------|--------|------|
| `perf` | `system perf` | 性能统计 |
| `reset` | `system reset` | 重置统计 |
| `diag` | `system diag` | 系统诊断 |
| `page motor` | `page motor` | 切换到电机页面 |
| `page imu` | `page imu` | 切换到IMU页面 |
| `help` | `help` | 显示帮助 (保持不变) |

---

## 错误处理和故障排除

### 常见错误类型

#### 1. 参数错误
```
错误：参数必须是 left 或 right
错误：PWM值范围为 -1000 到 +1000
错误：无效参数 'xxx'
```

#### 2. 参数数量错误
```
错误：参数过多，格式: pwm [left|right] [value]
错误：参数过多，格式: system [perf|reset|diag]
```

#### 3. 未知指令
```
未知指令: xxx
输入 'help' 查看可用指令
```

### 故障排除指南

#### 问题1: 指令无响应
**可能原因**: 
- 串口连接问题
- 波特率设置错误 (应为115200)
- 系统死锁

**解决方法**:
1. 检查串口连接和波特率
2. 发送简单指令如 `help` 测试
3. 重启系统

#### 问题2: 参数解析错误
**可能原因**:
- 参数格式错误
- 多余的空格
- 特殊字符

**解决方法**:
1. 检查参数格式是否正确
2. 确保参数间只有一个空格
3. 避免使用特殊字符

#### 问题3: 传感器数据异常
**可能原因**:
- 传感器未初始化
- 硬件连接问题
- 数据未就绪

**解决方法**:
1. 使用 `gary ping` 检测连接
2. 使用 `gary reinit` 重新初始化
3. 使用 `system diag` 进行系统诊断

---

## 技术实现说明

### 参数解析机制
新的指令系统采用简单的字符串分割实现参数解析，支持灵活的参数组合。

### 状态机兼容性
保持与原有状态机系统的完全兼容，确保交互式输入功能正常工作。

### 性能优化
- 减少48%的字符串比较操作
- 消除交互式输入等待时间
- 提升整体操作效率

---

## 版本历史

### v3.0 (2025年7月)
- 指令总数：23个 → 12个
- 优化循线状态判定
- 改进参数化设计

### v2.0 (2025年7月)
- 指令精简：23个 → 12个
- 引入参数化设计
- 功能整合优化
- 删除冗余指令

### v1.0 (之前版本)
- 基础指令系统
- 交互式输入设计
- 23个独立指令

---

**注意**: 本文档基于STM32F407VET6智能小车项目，所有指令均通过串口(UART1, 115200bps)进行通信。
